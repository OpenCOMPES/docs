
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sed.calibrator.energy &#8212; SED 1.0.0a1.dev3+g47b979b documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=d4e484fb"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/sed/calibrator/energy';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://raw.githubusercontent.com/OpenCOMPES/docs/main/sed/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.0.0a1.dev3+g47b979b';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            true;
        </script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="1.0.0a1.dev3+g47b979b" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">SED 1.0.0a1.dev3+g47b979b documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../workflows/index.html">
    Workflows
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../sed/api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../misc/contribution.html">
    Development
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/OpenCOMPES/sed" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
          
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../workflows/index.html">
    Workflows
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../sed/api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../misc/contribution.html">
    Development
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/OpenCOMPES/sed" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item"><nav class="sidebar-indices-items" aria-labelledby="pst-indices-navigation-heading-2">
  <p id="pst-indices-navigation-heading-2" class="sidebar-indices-items__title" role="heading" aria-level="1">Indices</p>
  <ul class="indices-link">
        <li class="toctree-l1">
          <a class="reference internal"
             href="../../../genindex.html"
             accesskey="I">General Index</a>
        </li>
        <li class="toctree-l1">
          <a class="reference internal" href="../../../py-modindex.html">Python Module Index</a>
        </li>
  </ul>
</nav></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">sed.calibrator.energy</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for sed.calibrator.energy</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;sed.calibrator.energy module. Code for energy calibration and</span>
<span class="sd">correction. Mostly ported from https://github.com/mpes-kit/mpes.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">it</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">bokeh.plotting</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pbk</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask.dataframe</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ipw</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">output_notebook</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bokeh.palettes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Category10</span> <span class="k">as</span> <span class="n">ColorCycle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastdtw</span><span class="w"> </span><span class="kn">import</span> <span class="n">fastdtw</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lmfit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Minimizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lmfit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameters</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lmfit.printfuncs</span><span class="w"> </span><span class="kn">import</span> <span class="n">fit_report</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">lstsq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">savgol_filter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">lsqr</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sed.binning</span><span class="w"> </span><span class="kn">import</span> <span class="n">bin_dataframe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sed.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">dfops</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sed.core.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_verbosity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sed.core.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sed.loader.base.loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseLoader</span>

<span class="c1"># Configure logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;delay&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="EnergyCalibrator">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EnergyCalibrator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Electron binding energy calibration workflow.</span>

<span class="sd">    For the initialization of the EnergyCalibrator class an instance of a</span>
<span class="sd">    loader is required. The data can be loaded using the optional arguments,</span>
<span class="sd">    or using the load_data method or bin_data method.</span>

<span class="sd">    Args:</span>
<span class="sd">        loader (BaseLoader): Instance of a loader, subclassed from BaseLoader.</span>
<span class="sd">        biases (np.ndarray, optional): Bias voltages used. Defaults to None.</span>
<span class="sd">        traces (np.ndarray, optional): TOF-Data traces corresponding to the bias</span>
<span class="sd">            values. Defaults to None.</span>
<span class="sd">        tof (np.ndarray, optional): TOF-values for the data traces.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        config (dict, optional): Config dictionary. Defaults to None.</span>
<span class="sd">        verbose (bool, optional): Option to print out diagnostic information.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loader</span><span class="p">:</span> <span class="n">BaseLoader</span><span class="p">,</span>
        <span class="n">biases</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">traces</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tof</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For the initialization of the EnergyCalibrator class an instance of a</span>
<span class="sd">        loader is required. The data can be loaded using the optional arguments,</span>
<span class="sd">        or using the load_data method or bin_data method.</span>

<span class="sd">        Args:</span>
<span class="sd">            loader (BaseLoader): Instance of a loader, subclassed from BaseLoader.</span>
<span class="sd">            biases (np.ndarray, optional): Bias voltages used. Defaults to None.</span>
<span class="sd">            traces (np.ndarray, optional): TOF-Data traces corresponding to the bias</span>
<span class="sd">                values. Defaults to None.</span>
<span class="sd">            tof (np.ndarray, optional): TOF-values for the data traces.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            config (dict, optional): Config dictionary. Defaults to None.</span>
<span class="sd">            verbose (bool, optional): Option to print out diagnostic information.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="n">set_verbosity</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">loader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traces_normed</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">traces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tof</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">biases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">biases</span><span class="o">=</span><span class="n">biases</span><span class="p">,</span> <span class="n">traces</span><span class="o">=</span><span class="n">traces</span><span class="p">,</span> <span class="n">tof</span><span class="o">=</span><span class="n">tof</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">featranges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Value ranges for feature detection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calibration&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tof_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">][</span><span class="s2">&quot;tof&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tof_ns_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tof_ns&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrected_tof_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">][</span><span class="s2">&quot;corrected_tof&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">][</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">][</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binwidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">][</span><span class="s2">&quot;tof_binwidth&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binning</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">][</span><span class="s2">&quot;tof_binning&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">][</span><span class="s2">&quot;x_width&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">][</span><span class="s2">&quot;y_width&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tof_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">][</span><span class="s2">&quot;tof_width&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">binning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tof_fermi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">][</span><span class="s2">&quot;tof_fermi&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">binning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color_clip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">][</span><span class="s2">&quot;color_clip&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sector_delays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sector_delays&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sector_id_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sector_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;offsets&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correction&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Accessor to the verbosity flag.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Verbosity flag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span>

    <span class="nd">@verbose</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setter for the verbosity.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose (bool): Option to turn on verbose output. Sets loglevel to INFO.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="n">set_verbosity</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ntraces</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Property returning the number of traces.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of loaded/calculated traces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nranges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Property returning the number of specified feature ranges which Can be a</span>
<span class="sd">        multiple of ntraces.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of specified feature ranges.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featranges</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Property returning the duplication number, i.e. the number of feature</span>
<span class="sd">        ranges per trace.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The duplication number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nranges</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntraces</span><span class="p">))</span>

<div class="viewcode-block" id="EnergyCalibrator.load_data">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">biases</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">traces</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tof</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load data into the class. Not provided parameters will be overwritten by</span>
<span class="sd">        empty arrays.</span>

<span class="sd">        Args:</span>
<span class="sd">            biases (np.ndarray, optional): Bias voltages used. Defaults to None.</span>
<span class="sd">            traces (np.ndarray, optional): TOF-Data traces corresponding to the bias</span>
<span class="sd">                values. Defaults to None.</span>
<span class="sd">            tof (np.ndarray, optional): TOF-values for the data traces.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">biases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biases</span> <span class="o">=</span> <span class="n">biases</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">tof</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tof</span> <span class="o">=</span> <span class="n">tof</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">traces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces_normed</span> <span class="o">=</span> <span class="n">traces</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([])</span></div>


<div class="viewcode-block" id="EnergyCalibrator.bin_data">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.bin_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bin_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">axes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bins</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ranges</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">biases</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bias_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Bin data from single-event files, and load into class.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_files (list[str]): list of file names to bin</span>
<span class="sd">            axes (list[str], optional): bin axes. Defaults to</span>
<span class="sd">                config[&quot;dataframe&quot;][&quot;columns&quot;][&quot;tof&quot;].</span>
<span class="sd">            bins (list[int], optional): number of bins.</span>
<span class="sd">                Defaults to config[&quot;energy&quot;][&quot;bins&quot;].</span>
<span class="sd">            ranges (Sequence[tuple[float, float]], optional): bin ranges.</span>
<span class="sd">                Defaults to config[&quot;energy&quot;][&quot;ranges&quot;].</span>
<span class="sd">            biases (np.ndarray, optional): Bias voltages used.</span>
<span class="sd">                If not provided, biases are extracted from the file meta data.</span>
<span class="sd">            bias_key (str, optional): hdf5 path where bias values are stored.</span>
<span class="sd">                Defaults to config[&quot;energy&quot;][&quot;bias_key&quot;].</span>
<span class="sd">            **kwds: Keyword parameters for bin_dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tof_column</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">][</span><span class="s2">&quot;bins&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ranges_</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">][</span><span class="s2">&quot;ranges&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">binning</span><span class="p">]</span>
            <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ranges_</span><span class="p">]</span>
        <span class="c1"># pylint: disable=duplicate-code</span>
        <span class="n">hist_mode</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;hist_mode&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;binning&quot;</span><span class="p">][</span><span class="s2">&quot;hist_mode&quot;</span><span class="p">])</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;binning&quot;</span><span class="p">][</span><span class="s2">&quot;mode&quot;</span><span class="p">])</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pbar&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;binning&quot;</span><span class="p">][</span><span class="s2">&quot;pbar&quot;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_cores</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;num_cores&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;core&quot;</span><span class="p">][</span><span class="s2">&quot;num_cores&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">num_cores</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">threads_per_worker</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
            <span class="s2">&quot;threads_per_worker&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;binning&quot;</span><span class="p">][</span><span class="s2">&quot;threads_per_worker&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">threadpool_api</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;threadpool_API&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;binning&quot;</span><span class="p">][</span><span class="s2">&quot;threadpool_API&quot;</span><span class="p">])</span>

        <span class="n">read_biases</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">biases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">read_biases</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">bias_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">bias_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">][</span><span class="s2">&quot;bias_key&quot;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Either Bias Values or a valid bias_key has to be present!&quot;</span><span class="p">,</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>

        <span class="n">dataframe</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">read_dataframe</span><span class="p">(</span>
            <span class="n">files</span><span class="o">=</span><span class="n">data_files</span><span class="p">,</span>
            <span class="n">collect_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">traces</span> <span class="o">=</span> <span class="n">bin_dataframe</span><span class="p">(</span>
            <span class="n">dataframe</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
            <span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span>
            <span class="n">hist_mode</span><span class="o">=</span><span class="n">hist_mode</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">,</span>
            <span class="n">n_cores</span><span class="o">=</span><span class="n">num_cores</span><span class="p">,</span>
            <span class="n">threads_per_worker</span><span class="o">=</span><span class="n">threads_per_worker</span><span class="p">,</span>
            <span class="n">threadpool_api</span><span class="o">=</span><span class="n">threadpool_api</span><span class="p">,</span>
            <span class="n">return_partitions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">read_biases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bias_key</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">biases</span> <span class="o">=</span> <span class="n">extract_bias</span><span class="p">(</span><span class="n">data_files</span><span class="p">,</span> <span class="n">bias_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Either Bias Values or a valid bias_key has to be present!&quot;</span><span class="p">,</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="n">tof</span> <span class="o">=</span> <span class="n">traces</span><span class="o">.</span><span class="n">coords</span><span class="p">[(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">traces</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tof</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">biases</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnergyCalibrator.normalize">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.normalize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smooth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">span</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize the spectra along an axis.</span>

<span class="sd">        Args:</span>
<span class="sd">            smooth (bool, optional): Option to smooth the signals before normalization.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            span (int, optional): span smoothing parameters of the LOESS method</span>
<span class="sd">                (see ``scipy.signal.savgol_filter()``). Defaults to 7.</span>
<span class="sd">            order (int, optional): order smoothing parameters of the LOESS method</span>
<span class="sd">                (see ``scipy.signal.savgol_filter()``). Defaults to 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traces_normed</span> <span class="o">=</span> <span class="n">normspec</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">,</span>
            <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span>
            <span class="n">span</span><span class="o">=</span><span class="n">span</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Normalized energy calibration traces.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnergyCalibrator.adjust_ranges">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.adjust_ranges">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">adjust_ranges</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ranges</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
        <span class="n">ref_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">traces</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">peak_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
        <span class="n">apply</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display a tool to select or extract the equivalent feature ranges</span>
<span class="sd">        (containing the peaks) among all traces.</span>

<span class="sd">        Args:</span>
<span class="sd">            ranges (tuple):</span>
<span class="sd">                Collection of feature detection ranges, within which an algorithm</span>
<span class="sd">                (i.e. 1D peak detector) with look for the feature.</span>
<span class="sd">            ref_id (int, optional): Index of the reference trace. Defaults to 0.</span>
<span class="sd">            traces (np.ndarray, optional): Collection of energy dispersion curves.</span>
<span class="sd">                Defaults to self.traces_normed.</span>
<span class="sd">            peak_window (int, optional): area around a peak to check for other peaks.</span>
<span class="sd">                Defaults to 7.</span>
<span class="sd">            apply (bool, optional): Option to directly apply the provided parameters.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            **kwds: keyword arguments</span>
<span class="sd">                - *labels*: List of labels for plotting. Default uses the bias voltages.</span>
<span class="sd">                - *figsize* Figure size.</span>
<span class="sd">                Additional keyword arguments are passed to ``find_correspondence()``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">traces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces_normed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_ranges</span><span class="p">(</span>
            <span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span>
            <span class="n">ref_id</span><span class="o">=</span><span class="n">ref_id</span><span class="p">,</span>
            <span class="n">traces</span><span class="o">=</span><span class="n">traces</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_extract</span><span class="p">(</span><span class="n">peak_window</span><span class="o">=</span><span class="n">peak_window</span><span class="p">)</span>

        <span class="c1"># make plot</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; V&quot;</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">])</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;figsize&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">plot_segs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plot_peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.prop_cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">itr</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traces</span><span class="p">)),</span> <span class="n">colors</span><span class="p">):</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="n">itr</span><span class="p">,</span> <span class="p">:]</span>
            <span class="c1"># main traces</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">itr</span><span class="p">])</span>
            <span class="c1"># segments:</span>
            <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featranges</span><span class="p">[</span><span class="n">itr</span><span class="p">]</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span> <span class="o">&gt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tofseg</span><span class="p">,</span> <span class="n">traceseg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">[</span><span class="n">cond</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>
            <span class="p">(</span><span class="n">line</span><span class="p">,)</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tofseg</span><span class="p">,</span> <span class="n">traceseg</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">plot_segs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="c1"># markers</span>
            <span class="p">(</span><span class="n">scatt</span><span class="p">,)</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="n">itr</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="n">itr</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">plot_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scatt</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time-of-flight&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Intensity&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">refid</span><span class="p">,</span> <span class="n">ranges</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="p">,</span> <span class="n">refid</span><span class="p">,</span> <span class="n">traces</span><span class="o">=</span><span class="n">traces</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_extract</span><span class="p">(</span><span class="n">peak_window</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">itr</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traces_normed</span><span class="p">):</span>
                <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featranges</span><span class="p">[</span><span class="n">itr</span><span class="p">]</span>
                <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span> <span class="o">&gt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">tofseg</span><span class="p">,</span> <span class="n">traceseg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">[</span><span class="n">cond</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">traces_normed</span><span class="p">[</span><span class="n">itr</span><span class="p">][</span><span class="n">cond</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">plot_segs</span><span class="p">[</span><span class="n">itr</span><span class="p">]</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">traceseg</span><span class="p">)</span>
                <span class="n">plot_segs</span><span class="p">[</span><span class="n">itr</span><span class="p">]</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">tofseg</span><span class="p">)</span>

                <span class="n">plot_peaks</span><span class="p">[</span><span class="n">itr</span><span class="p">]</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="n">itr</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
                <span class="n">plot_peaks</span><span class="p">[</span><span class="n">itr</span><span class="p">]</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="n">itr</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>

        <span class="n">refid_slider</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">ref_id</span><span class="p">,</span>
            <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ranges_slider</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">IntRangeSlider</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">ranges</span><span class="p">),</span>
            <span class="nb">min</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">),</span>
            <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">),</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">update</span><span class="p">(</span><span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span> <span class="n">refid</span><span class="o">=</span><span class="n">ref_id</span><span class="p">)</span>

        <span class="n">ipw</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span>
            <span class="n">update</span><span class="p">,</span>
            <span class="n">refid</span><span class="o">=</span><span class="n">refid_slider</span><span class="p">,</span>
            <span class="n">ranges</span><span class="o">=</span><span class="n">ranges_slider</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">apply_func</span><span class="p">(</span><span class="n">apply</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>  <span class="c1"># noqa: ARG001</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_ranges</span><span class="p">(</span>
                <span class="n">ranges_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">refid_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">traces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">traces_normed</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Use feature ranges: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">featranges</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_extract</span><span class="p">(</span><span class="n">peak_window</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted energy features: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">ranges_slider</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">refid_slider</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">apply_button</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">apply_button</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;apply&quot;</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">apply_button</span><span class="p">)</span>  <span class="c1"># pylint: disable=duplicate-code</span>
        <span class="n">apply_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">apply_func</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">apply</span><span class="p">:</span>
            <span class="n">apply_func</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnergyCalibrator.add_ranges">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.add_ranges">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_ranges</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ranges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">,</span>
        <span class="n">ref_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">traces</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">infer_others</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select or extract the equivalent feature ranges (containing the peaks) among all traces.</span>

<span class="sd">        Args:</span>
<span class="sd">            ranges (list[tuple] | tuple):</span>
<span class="sd">                Collection of feature detection ranges, within which an algorithm</span>
<span class="sd">                (i.e. 1D peak detector) with look for the feature.</span>
<span class="sd">            ref_id (int, optional): Index of the reference trace. Defaults to 0.</span>
<span class="sd">            traces (np.ndarray, optional): Collection of energy dispersion curves.</span>
<span class="sd">                Defaults to self.traces_normed.</span>
<span class="sd">            infer_others (bool, optional): Option to infer the feature detection range</span>
<span class="sd">                in other traces from a given one using a time warp algorithm.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            mode (str, optional): Specification on how to change the feature ranges</span>
<span class="sd">                (&#39;append&#39; or &#39;replace&#39;). Defaults to &quot;replace&quot;.</span>
<span class="sd">            **kwds:</span>
<span class="sd">                keyword arguments for trace alignment (see ``find_correspondence()``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">traces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces_normed</span>

        <span class="c1"># Infer the corresponding feature detection range of other traces by alignment</span>
        <span class="k">if</span> <span class="n">infer_others</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ranges</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="n">newranges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntraces</span><span class="p">):</span>
                <span class="n">pathcorr</span> <span class="o">=</span> <span class="n">find_correspondence</span><span class="p">(</span>
                    <span class="n">traces</span><span class="p">[</span><span class="n">ref_id</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="n">traces</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">newranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">range_convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">pathcorr</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ranges</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">newranges</span> <span class="o">=</span> <span class="n">ranges</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">ranges</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;append&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">featranges</span> <span class="o">+=</span> <span class="n">newranges</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;replace&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">featranges</span> <span class="o">=</span> <span class="n">newranges</span></div>


<div class="viewcode-block" id="EnergyCalibrator.feature_extract">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.feature_extract">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">feature_extract</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ranges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">traces</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">peak_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select or extract the equivalent landmarks (e.g. peaks) among all traces.</span>

<span class="sd">        Args:</span>
<span class="sd">            ranges (list[tuple], optional):  List of ranges in each trace to look for</span>
<span class="sd">                the peak feature, [start, end]. Defaults to self.featranges.</span>
<span class="sd">            traces (np.ndarray, optional): Collection of 1D spectra to use for</span>
<span class="sd">                calibration. Defaults to self.traces_normed.</span>
<span class="sd">            peak_window (int, optional): area around a peak to check for other peaks.</span>
<span class="sd">                Defaults to 7.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featranges</span>

        <span class="k">if</span> <span class="n">traces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces_normed</span>

        <span class="c1"># Augment the content of the calibration data</span>
        <span class="n">traces_aug</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dup</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Run peak detection for each trace within the specified ranges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="n">peaksearch</span><span class="p">(</span>
            <span class="n">traces_aug</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">,</span>
            <span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span>
            <span class="n">pkwindow</span><span class="o">=</span><span class="n">peak_window</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="EnergyCalibrator.calibrate">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.calibrate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calibrate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ref_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;lmfit&quot;</span><span class="p">,</span>
        <span class="n">energy_scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;kinetic&quot;</span><span class="p">,</span>
        <span class="n">landmarks</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">biases</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the functional mapping between time-of-flight and the energy</span>
<span class="sd">        scale using optimization methods.</span>

<span class="sd">        Args:</span>
<span class="sd">            ref_energy (float): Binding/kinetic energy of the detected feature.</span>
<span class="sd">            method (str, optional):  Method for determining the energy calibration.</span>

<span class="sd">                - **&#39;lmfit&#39;**: Energy calibration using lmfit and 1/t^2 form.</span>
<span class="sd">                - **&#39;lstsq&#39;**, **&#39;lsqr&#39;**: Energy calibration using polynomial form.</span>

<span class="sd">                Defaults to &#39;lmfit&#39;.</span>
<span class="sd">            energy_scale (str, optional): Direction of increasing energy scale.</span>

<span class="sd">                - **&#39;kinetic&#39;**: increasing energy with decreasing TOF.</span>
<span class="sd">                - **&#39;binding&#39;**: increasing energy with increasing TOF.</span>

<span class="sd">                Defaults to &quot;kinetic&quot;.</span>
<span class="sd">            landmarks (np.ndarray, optional): Extracted peak positions (TOF) used for</span>
<span class="sd">                calibration. Defaults to self.peaks.</span>
<span class="sd">            biases (np.ndarray, optional): Bias values. Defaults to self.biases.</span>
<span class="sd">            t (np.ndarray, optional): TOF values. Defaults to self.tof.</span>
<span class="sd">            **kwds: keyword arguments.</span>
<span class="sd">                See available keywords for ``poly_energy_calibration()`` and</span>
<span class="sd">                ``fit_energy_calibration()``</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Raised if invalid &#39;energy_scale&#39; is passed.</span>
<span class="sd">            NotImplementedError: Raised if invalid &#39;method&#39; is passed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Calibration dictionary with coefficients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">landmarks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">landmarks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">biases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">biases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biases</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof</span>
        <span class="k">if</span> <span class="n">energy_scale</span> <span class="o">==</span> <span class="s2">&quot;kinetic&quot;</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">energy_scale</span> <span class="o">==</span> <span class="s2">&quot;binding&quot;</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;energy_scale needs to be either &quot;binding&quot; or &quot;kinetic&quot;&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;, got </span><span class="si">{</span><span class="n">energy_scale</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">binwidth</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;binwidth&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binwidth</span><span class="p">)</span>
        <span class="n">binning</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;binning&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binning</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;lmfit&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span> <span class="o">=</span> <span class="n">fit_energy_calibration</span><span class="p">(</span>
                <span class="n">landmarks</span><span class="p">,</span>
                <span class="n">sign</span> <span class="o">*</span> <span class="n">biases</span><span class="p">,</span>
                <span class="n">binwidth</span><span class="p">,</span>
                <span class="n">binning</span><span class="p">,</span>
                <span class="n">ref_energy</span><span class="o">=</span><span class="n">ref_energy</span><span class="p">,</span>
                <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                <span class="n">energy_scale</span><span class="o">=</span><span class="n">energy_scale</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;lstsq&quot;</span><span class="p">,</span> <span class="s2">&quot;lsqr&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span> <span class="o">=</span> <span class="n">poly_energy_calibration</span><span class="p">(</span>
                <span class="n">landmarks</span><span class="p">,</span>
                <span class="n">sign</span> <span class="o">*</span> <span class="n">biases</span><span class="p">,</span>
                <span class="n">ref_energy</span><span class="o">=</span><span class="n">ref_energy</span><span class="p">,</span>
                <span class="n">aug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dup</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                <span class="n">energy_scale</span><span class="o">=</span><span class="n">energy_scale</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span></div>


<div class="viewcode-block" id="EnergyCalibrator.view">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.view">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">traces</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">segs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">peaks</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show_legend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;matplotlib&quot;</span><span class="p">,</span>
        <span class="n">linekwds</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">linesegkwds</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">scatterkwds</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">legkwds</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display a plot showing line traces with annotation.</span>

<span class="sd">        Args:</span>
<span class="sd">            traces (np.ndarray): Matrix of traces to visualize.</span>
<span class="sd">            segs (list[tuple], optional): Segments to be highlighted in the</span>
<span class="sd">                visualization. Defaults to None.</span>
<span class="sd">            peaks (np.ndarray, optional): Peak positions for labelling the traces.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            show_legend (bool, optional): Option to display bias voltages as legends.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            backend (str, optional): Backend specification, choose between &#39;matplotlib&#39;</span>
<span class="sd">                (static) or &#39;bokeh&#39; (interactive). Defaults to &quot;matplotlib&quot;.</span>
<span class="sd">            linekwds (dict, optional): Keyword arguments for line plotting</span>
<span class="sd">                (see ``matplotlib.pyplot.plot()``). Defaults to {}.</span>
<span class="sd">            linesegkwds (dict, optional): Keyword arguments for line segments plotting</span>
<span class="sd">                (see ``matplotlib.pyplot.plot()``). Defaults to {}.</span>
<span class="sd">            scatterkwds (dict, optional): Keyword arguments for scatter plot</span>
<span class="sd">                (see ``matplotlib.pyplot.scatter()``). Defaults to {}.</span>
<span class="sd">            legkwds (dict, optional): Keyword arguments for legend</span>
<span class="sd">                (see ``matplotlib.pyplot.legend()``). Defaults to {}.</span>
<span class="sd">            **kwds: keyword arguments:</span>

<span class="sd">                - **labels** (list): Labels for each curve</span>
<span class="sd">                - **xaxis** (np.ndarray): x (horizontal) axis values</span>
<span class="sd">                - **title** (str): Title of the plot</span>
<span class="sd">                - **legend_location** (str): Location of the plot legend</span>
<span class="sd">                - **align** (bool): Option to shift traces by bias voltage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lbs</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; V&quot;</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">])</span>
        <span class="n">xaxis</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;xaxis&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">)</span>
        <span class="n">ttl</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">align</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;align&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;energy_scale&quot;</span><span class="p">,</span> <span class="s2">&quot;kinetic&quot;</span><span class="p">)</span>

        <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">energy_scale</span> <span class="o">==</span> <span class="s2">&quot;kinetic&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;figsize&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;matplotlib&quot;</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.prop_cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">itr</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traces</span><span class="p">)),</span> <span class="n">colors</span><span class="p">):</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="n">itr</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="n">align</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">xaxis</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">[</span><span class="n">itr</span><span class="p">]),</span>
                        <span class="n">trace</span><span class="p">,</span>
                        <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">lbs</span><span class="p">[</span><span class="n">itr</span><span class="p">],</span>
                        <span class="o">**</span><span class="n">linekwds</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">xaxis</span><span class="p">,</span>
                        <span class="n">trace</span><span class="p">,</span>
                        <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">lbs</span><span class="p">[</span><span class="n">itr</span><span class="p">],</span>
                        <span class="o">**</span><span class="n">linekwds</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># Emphasize selected EDC segments</span>
                <span class="k">if</span> <span class="n">segs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">seg</span> <span class="o">=</span> <span class="n">segs</span><span class="p">[</span><span class="n">itr</span><span class="p">]</span>
                    <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span> <span class="o">&gt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">tofseg</span><span class="p">,</span> <span class="n">traceseg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">[</span><span class="n">cond</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">tofseg</span><span class="p">,</span>
                        <span class="n">traceseg</span><span class="p">,</span>
                        <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">linesegkwds</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="c1"># Emphasize extracted local maxima</span>
                <span class="k">if</span> <span class="n">peaks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                        <span class="n">peaks</span><span class="p">[</span><span class="n">itr</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="n">peaks</span><span class="p">[</span><span class="n">itr</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">scatterkwds</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">show_legend</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">legkwds</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ttl</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;bokeh&quot;</span><span class="p">:</span>
            <span class="n">output_notebook</span><span class="p">(</span><span class="n">hide_banner</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">ColorCycle</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">ttp</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;(x, y)&quot;</span><span class="p">,</span> <span class="s2">&quot;($x, $y)&quot;</span><span class="p">)]</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">pbk</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="n">ttl</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">tooltips</span><span class="o">=</span><span class="n">ttp</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Plotting the main traces</span>
            <span class="k">for</span> <span class="n">itr</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traces</span><span class="p">)),</span> <span class="n">colors</span><span class="p">):</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="n">itr</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="n">align</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
                        <span class="n">xaxis</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">[</span><span class="n">itr</span><span class="p">]),</span>
                        <span class="n">trace</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">line_dash</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
                        <span class="n">line_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">line_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">legend_label</span><span class="o">=</span><span class="n">lbs</span><span class="p">[</span><span class="n">itr</span><span class="p">],</span>
                        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
                        <span class="n">xaxis</span><span class="p">,</span>
                        <span class="n">trace</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">line_dash</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
                        <span class="n">line_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">line_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">legend_label</span><span class="o">=</span><span class="n">lbs</span><span class="p">[</span><span class="n">itr</span><span class="p">],</span>
                        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># Emphasize selected EDC segments</span>
                <span class="k">if</span> <span class="n">segs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">seg</span> <span class="o">=</span> <span class="n">segs</span><span class="p">[</span><span class="n">itr</span><span class="p">]</span>
                    <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span> <span class="o">&gt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">tofseg</span><span class="p">,</span> <span class="n">traceseg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">[</span><span class="n">cond</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
                        <span class="n">tofseg</span><span class="p">,</span>
                        <span class="n">traceseg</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">linekwds</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># Plot detected peaks</span>
                <span class="k">if</span> <span class="n">peaks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                        <span class="n">peaks</span><span class="p">[</span><span class="n">itr</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="n">peaks</span><span class="p">[</span><span class="n">itr</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">fill_color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                        <span class="n">line_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">scatterkwds</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">show_legend</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;legend_location&quot;</span><span class="p">,</span> <span class="s2">&quot;top_right&quot;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="n">pbk</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnergyCalibrator.append_energy_axis">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.append_energy_axis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">append_energy_axis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">tof_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">energy_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">calibration</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bias_voltage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">suppress_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate and append the energy axis to the events dataframe.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame | dask.dataframe.DataFrame):</span>
<span class="sd">                Dataframe to apply the energy axis calibration to.</span>
<span class="sd">            tof_column (str, optional): Label of the source column.</span>
<span class="sd">                Defaults to config[&quot;dataframe&quot;][&quot;columns&quot;][&quot;tof&quot;].</span>
<span class="sd">            energy_column (str, optional): Label of the destination column.</span>
<span class="sd">                Defaults to config[&quot;dataframe&quot;][&quot;columns&quot;][&quot;energy&quot;].</span>
<span class="sd">            calibration (dict, optional): Calibration dictionary. If provided,</span>
<span class="sd">                overrides calibration from class or config.</span>
<span class="sd">                Defaults to self.calibration or config[&quot;energy&quot;][&quot;calibration&quot;].</span>
<span class="sd">            bias_voltage (float, optional): Sample bias voltage of the scan data. If omitted,</span>
<span class="sd">                the bias voltage is being read from the dataframe. If it is not found there,</span>
<span class="sd">                a warning is printed and the calibrated data might have an offset.</span>
<span class="sd">            verbose (bool, optional): Option to suppress output of diagnostic information.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            **kwds: additional keyword arguments for the energy conversion. They are</span>
<span class="sd">                added to the calibration dictionary.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Raised if expected calibration parameters are missing.</span>
<span class="sd">            NotImplementedError: Raised if an invalid calib_type is found.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[pd.DataFrame | dask.dataframe.DataFrame, dict]: dataframe with added column</span>
<span class="sd">            and energy calibration metadata dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tof_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_tof_column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">tof_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_tof_column</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tof_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof_column</span>

        <span class="k">if</span> <span class="n">energy_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">energy_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_column</span>

        <span class="n">binwidth</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;binwidth&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binwidth</span><span class="p">)</span>
        <span class="n">binning</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;binning&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binning</span><span class="p">)</span>

        <span class="c1"># pylint: disable=duplicate-code</span>
        <span class="k">if</span> <span class="n">calibration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">calibration</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">calibration</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">elif</span> <span class="s2">&quot;creation_date&quot;</span> <span class="ow">in</span> <span class="n">calibration</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">suppress_output</span><span class="p">:</span>
            <span class="n">datestring</span> <span class="o">=</span> <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y, %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using energy calibration parameters generated on </span><span class="si">{</span><span class="n">datestring</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># try to determine calibration type if not provided</span>
        <span class="k">if</span> <span class="s2">&quot;calib_type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calibration</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;t0&quot;</span> <span class="ow">in</span> <span class="n">calibration</span> <span class="ow">and</span> <span class="s2">&quot;d&quot;</span> <span class="ow">in</span> <span class="n">calibration</span> <span class="ow">and</span> <span class="s2">&quot;E0&quot;</span> <span class="ow">in</span> <span class="n">calibration</span><span class="p">:</span>
                <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;calib_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;fit&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;energy_scale&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calibration</span><span class="p">:</span>
                    <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;energy_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;kinetic&quot;</span>

            <span class="k">elif</span> <span class="s2">&quot;coeffs&quot;</span> <span class="ow">in</span> <span class="n">calibration</span> <span class="ow">and</span> <span class="s2">&quot;E0&quot;</span> <span class="ow">in</span> <span class="n">calibration</span><span class="p">:</span>
                <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;calib_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;poly&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;energy_scale&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calibration</span><span class="p">:</span>
                    <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;energy_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;kinetic&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid calibration parameters provided!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;calib_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fit&quot;</span><span class="p">:</span>
            <span class="c1"># Fitting metadata for nexus</span>
            <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;fit_function&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;(a0/(x0-a1))**2 + a2&quot;</span>
            <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;coefficients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">],</span>
                    <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">],</span>
                    <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">],</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="n">energy_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">tof2ev</span><span class="p">(</span>
                <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">],</span>
                <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">],</span>
                <span class="n">binwidth</span><span class="p">,</span>
                <span class="n">binning</span><span class="p">,</span>
                <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;energy_scale&quot;</span><span class="p">],</span>
                <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">],</span>
                <span class="n">df</span><span class="p">[</span><span class="n">tof_column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;calib_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;poly&quot;</span><span class="p">:</span>
            <span class="c1"># Fitting metadata for nexus</span>
            <span class="n">fit_function</span> <span class="o">=</span> <span class="s2">&quot;a0&quot;</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;coeffs&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">fit_function</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; + a</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">*x0**</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;fit_function&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_function</span>
            <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;coefficients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;coeffs&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">]]),</span>
            <span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">energy_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">tof2evpoly</span><span class="p">(</span>
                <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;coeffs&quot;</span><span class="p">],</span>
                <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">],</span>
                <span class="n">df</span><span class="p">[</span><span class="n">tof_column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_output</span><span class="p">:</span>
            <span class="n">report_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;calib_type&quot;</span><span class="p">:</span> <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;calib_type&quot;</span><span class="p">],</span>
                <span class="s2">&quot;fit_function&quot;</span><span class="p">:</span> <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;fit_function&quot;</span><span class="p">],</span>
                <span class="s2">&quot;coefficients&quot;</span><span class="p">:</span> <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;coefficients&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Used energy calibration parameters: </span><span class="si">{</span><span class="n">report_dict</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># apply bias offset</span>
        <span class="n">scale_sign</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;energy_scale&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;binding&quot;</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">bias_voltage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">energy_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">energy_column</span><span class="p">]</span> <span class="o">+</span> <span class="n">scale_sign</span> <span class="o">*</span> <span class="n">bias_voltage</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_output</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shifted energy column by constant bias value: </span><span class="si">{</span><span class="n">bias_voltage</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">][</span><span class="s2">&quot;bias&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">dfops</span><span class="o">.</span><span class="n">offset_by_other_columns</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">target_column</span><span class="o">=</span><span class="n">energy_column</span><span class="p">,</span>
                <span class="n">offset_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;dataframe&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">][</span><span class="s2">&quot;bias&quot;</span><span class="p">],</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">scale_sign</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_output</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Shifted energy column by bias column: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;dataframe&#39;</span><span class="p">][</span><span class="s1">&#39;columns&#39;</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Sample bias data not found or provided. Calibrated energy might be incorrect.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather_calibration_metadata</span><span class="p">(</span><span class="n">calibration</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="EnergyCalibrator.append_tof_ns_axis">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.append_tof_ns_axis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">append_tof_ns_axis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">tof_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tof_ns_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts the time-of-flight time from steps to time in ns.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame | dask.dataframe.DataFrame): Dataframe to convert.</span>
<span class="sd">            tof_column (str, optional): Name of the column containing the</span>
<span class="sd">                time-of-flight steps. Defaults to config[&quot;dataframe&quot;][&quot;columns&quot;][&quot;tof&quot;].</span>
<span class="sd">            tof_ns_column (str, optional): Name of the column to store the</span>
<span class="sd">                time-of-flight in nanoseconds. Defaults to config[&quot;dataframe&quot;][&quot;columns&quot;][&quot;tof_ns&quot;].</span>
<span class="sd">            binwidth (float, optional): Time-of-flight binwidth in ns.</span>
<span class="sd">                Defaults to config[&quot;energy&quot;][&quot;tof_binwidth&quot;].</span>
<span class="sd">            binning (int, optional): Time-of-flight binning factor.</span>
<span class="sd">                Defaults to config[&quot;energy&quot;][&quot;tof_binning&quot;].</span>
<span class="sd">            **kwds:</span>

<span class="sd">                - **binwidth**: Binwidth in ns.</span>
<span class="sd">                - **binning**: Binning factor of the TOF column.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[pd.DataFrame | dask.dataframe.DataFrame, dict]: Dataframe with the new columns</span>
<span class="sd">            and Metadata dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">binwidth</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;binwidth&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binwidth</span><span class="p">)</span>
        <span class="n">binning</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;binning&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binning</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;append_tof_ns_axis() got unexpected keyword arguments </span><span class="si">{</span><span class="n">kwds</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tof_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_tof_column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">tof_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_tof_column</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tof_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof_column</span>

        <span class="k">if</span> <span class="n">tof_ns_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tof_ns_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof_ns_column</span>

        <span class="n">df</span><span class="p">[</span><span class="n">tof_ns_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">tof2ns</span><span class="p">(</span>
            <span class="n">binwidth</span><span class="p">,</span>
            <span class="n">binning</span><span class="p">,</span>
            <span class="n">df</span><span class="p">[</span><span class="n">tof_column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;applied&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;binwidth&quot;</span><span class="p">:</span> <span class="n">binwidth</span><span class="p">,</span>
            <span class="s2">&quot;binning&quot;</span><span class="p">:</span> <span class="n">binning</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="EnergyCalibrator.gather_calibration_metadata">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.gather_calibration_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gather_calibration_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calibration</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collects metadata from the energy calibration</span>

<span class="sd">        Args:</span>
<span class="sd">            calibration (dict, optional): Dictionary with energy calibration</span>
<span class="sd">                parameters. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Generated metadata dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">calibration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">calibration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;applied&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;calibration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">calibration</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;tof&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tof</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;tof&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;tof&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># create empty calibrated axis entry, if it is not present.</span>
        <span class="k">if</span> <span class="s2">&quot;axis&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;calibration&quot;</span><span class="p">]:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;calibration&quot;</span><span class="p">][</span><span class="s2">&quot;axis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="EnergyCalibrator.adjust_energy_correction">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.adjust_energy_correction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">adjust_energy_correction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="n">correction_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">center</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">correction</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">apply</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualize the energy correction function on top of the TOF/X/Y graphs.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (xr.DataArray): Image data cube (x, y, tof) of binned data to plot.</span>
<span class="sd">            correction_type (str, optional): Type of correction to apply to the TOF</span>
<span class="sd">                axis. Valid values are:</span>

<span class="sd">                - &#39;spherical&#39;</span>
<span class="sd">                - &#39;Lorentzian&#39;</span>
<span class="sd">                - &#39;Gaussian&#39;</span>
<span class="sd">                - &#39;Lorentzian_asymmetric&#39;</span>

<span class="sd">                Defaults to config[&quot;energy&quot;][&quot;correction_type&quot;].</span>
<span class="sd">            amplitude (float, optional): Amplitude of the time-of-flight correction</span>
<span class="sd">                term. Defaults to config[&quot;energy&quot;][&quot;correction&quot;][&quot;correction_type&quot;].</span>
<span class="sd">            center (tuple[float, float], optional): Center (x/y) coordinates for the</span>
<span class="sd">                correction. Defaults to config[&quot;energy&quot;][&quot;correction&quot;][&quot;center&quot;].</span>
<span class="sd">            correction (dict, optional): Correction dict. Defaults to the config values</span>
<span class="sd">                and is updated from provided and adjusted parameters.</span>
<span class="sd">            apply (bool, optional): whether to store the provided parameters within</span>
<span class="sd">                the class. Defaults to False.</span>
<span class="sd">            **kwds: Additional parameters to use for the adjustment plots:</span>

<span class="sd">                - **x_column** (str): Name of the x column.</span>
<span class="sd">                - **y_column** (str): Name of the y column.</span>
<span class="sd">                - **tof_column** (str): Name of the tog column to convert.</span>
<span class="sd">                - **x_width** (int, int): x range to integrate around the center</span>
<span class="sd">                - **y_width** (int, int): y range to integrate around the center</span>
<span class="sd">                - **tof_fermi** (int): TOF value of the Fermi level</span>
<span class="sd">                - **tof_width** (int, int): TOF range to plot around tof_fermi</span>
<span class="sd">                - **color_clip** (int): highest value to plot in the color range</span>

<span class="sd">                Additional parameters for the correction functions:</span>

<span class="sd">                - **d** (float): Field-free drift distance.</span>
<span class="sd">                - **gamma** (float): Linewidth value for correction using a 2D</span>
<span class="sd">                  Lorentz profile.</span>
<span class="sd">                - **sigma** (float): Standard deviation for correction using a 2D</span>
<span class="sd">                  Gaussian profile.</span>
<span class="sd">                - **gamma2** (float): Linewidth value for correction using an</span>
<span class="sd">                  asymmetric 2D Lorentz profile, X-direction.</span>
<span class="sd">                - **amplitude2** (float): Amplitude value for correction using an</span>
<span class="sd">                  asymmetric 2D Lorentz profile, X-direction.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Raised for invalid correction_type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;module://ipympl.backend_nbagg&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">correction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">correction</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">correction_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;correction_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction_type</span>

        <span class="k">if</span> <span class="n">amplitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amplitude</span>

        <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span>

        <span class="n">x_column</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;x_column&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_column</span><span class="p">)</span>
        <span class="n">y_column</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;y_column&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_column</span><span class="p">)</span>
        <span class="n">tof_column</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tof_column&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof_column</span><span class="p">)</span>
        <span class="n">x_width</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;x_width&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_width</span><span class="p">)</span>
        <span class="n">y_width</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;y_width&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_width</span><span class="p">)</span>
        <span class="n">tof_fermi</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tof_fermi&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof_fermi</span><span class="p">)</span>
        <span class="n">tof_width</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tof_width&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof_width</span><span class="p">)</span>
        <span class="n">color_clip</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color_clip&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_clip</span><span class="p">)</span>

        <span class="n">correction</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">correction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">{</span><span class="s2">&quot;correction_type&quot;</span><span class="p">,</span> <span class="s2">&quot;amplitude&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">correction</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No valid energy correction found in config and required parameters missing!&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">])</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">x_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">y_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">x_center</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_center</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">correction_x</span> <span class="o">=</span> <span class="n">tof_fermi</span> <span class="o">-</span> <span class="n">correction_function</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_center</span><span class="p">,</span>
            <span class="o">**</span><span class="n">correction</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">correction_y</span> <span class="o">=</span> <span class="n">tof_fermi</span> <span class="o">-</span> <span class="n">correction_function</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_center</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
            <span class="o">**</span><span class="n">correction</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">{</span>
                <span class="n">y_column</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">y_center</span> <span class="o">+</span> <span class="n">y_width</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_center</span> <span class="o">+</span> <span class="n">y_width</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">tof_column</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span>
                    <span class="n">tof_fermi</span> <span class="o">+</span> <span class="n">tof_width</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">tof_fermi</span> <span class="o">+</span> <span class="n">tof_width</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">),</span>
            <span class="p">}</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">y_column</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain_r&quot;</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">color_clip</span><span class="p">,</span>
            <span class="n">yincrease</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">{</span>
                <span class="n">x_column</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">x_center</span> <span class="o">+</span> <span class="n">x_width</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_center</span> <span class="o">+</span> <span class="n">x_width</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">tof_column</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span>
                    <span class="n">tof_fermi</span> <span class="o">+</span> <span class="n">tof_width</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">tof_fermi</span> <span class="o">+</span> <span class="n">tof_width</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">),</span>
            <span class="p">}</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">x_column</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain_r&quot;</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">color_clip</span><span class="p">,</span>
            <span class="n">yincrease</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="n">trace1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">correction_x</span><span class="p">)</span>
        <span class="n">line1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_center</span><span class="p">)</span>
        <span class="p">(</span><span class="n">trace2</span><span class="p">,)</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">correction_y</span><span class="p">)</span>
        <span class="n">line2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y_center</span><span class="p">)</span>

        <span class="n">amplitude_slider</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">],</span>
            <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">x_center_slider</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">x_center</span><span class="p">,</span>
            <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;momentum&quot;</span><span class="p">][</span><span class="s2">&quot;detector_ranges&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">y_center_slider</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">y_center</span><span class="p">,</span>
            <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;momentum&quot;</span><span class="p">][</span><span class="s2">&quot;detector_ranges&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">correction</span>
            <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amplitude</span>
            <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">)</span>
            <span class="n">correction</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">correction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">}</span>
            <span class="n">correction_x</span> <span class="o">=</span> <span class="n">tof_fermi</span> <span class="o">-</span> <span class="n">correction_function</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y_center</span><span class="p">,</span>
                <span class="o">**</span><span class="n">correction</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">correction_y</span> <span class="o">=</span> <span class="n">tof_fermi</span> <span class="o">-</span> <span class="n">correction_function</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x_center</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                <span class="o">**</span><span class="n">correction</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">trace1</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">correction_x</span><span class="p">)</span>
            <span class="n">line1</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">([</span><span class="n">x_center</span><span class="p">])</span>
            <span class="n">trace2</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">correction_y</span><span class="p">)</span>
            <span class="n">line2</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">([</span><span class="n">y_center</span><span class="p">])</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">common_apply_func</span><span class="p">(</span><span class="n">apply</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>  <span class="c1"># noqa: ARG001</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correction</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;correction_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;correction_type&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">amplitude_slider</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">x_center_slider</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">y_center_slider</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">apply_button</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;correction_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;spherical&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">update</span><span class="p">(</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">],</span> <span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">diameter</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;diameter&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Parameter &#39;diameter&#39; required for correction type &#39;spherical&#39;, &quot;</span><span class="p">,</span>
                    <span class="s2">&quot;but not present!&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>

            <span class="n">diameter_slider</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;diameter&quot;</span><span class="p">],</span>
                <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="nb">max</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ipw</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span>
                <span class="n">update</span><span class="p">,</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude_slider</span><span class="p">,</span>
                <span class="n">x_center</span><span class="o">=</span><span class="n">x_center_slider</span><span class="p">,</span>
                <span class="n">y_center</span><span class="o">=</span><span class="n">y_center_slider</span><span class="p">,</span>
                <span class="n">diameter</span><span class="o">=</span><span class="n">diameter_slider</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">apply_func</span><span class="p">(</span><span class="n">apply</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">common_apply_func</span><span class="p">(</span><span class="n">apply</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;diameter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;diameter&quot;</span><span class="p">]</span>
                <span class="n">diameter_slider</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;correction_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Lorentzian&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">update</span><span class="p">(</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">],</span> <span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Parameter &#39;gamma&#39; required for correction type &#39;Lorentzian&#39;, but not present!&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>

            <span class="n">gamma_slider</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">],</span>
                <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="nb">max</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ipw</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span>
                <span class="n">update</span><span class="p">,</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude_slider</span><span class="p">,</span>
                <span class="n">x_center</span><span class="o">=</span><span class="n">x_center_slider</span><span class="p">,</span>
                <span class="n">y_center</span><span class="o">=</span><span class="n">y_center_slider</span><span class="p">,</span>
                <span class="n">gamma</span><span class="o">=</span><span class="n">gamma_slider</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">apply_func</span><span class="p">(</span><span class="n">apply</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">common_apply_func</span><span class="p">(</span><span class="n">apply</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span>
                <span class="n">gamma_slider</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;correction_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">update</span><span class="p">(</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">],</span> <span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Parameter &#39;sigma&#39; required for correction type &#39;Gaussian&#39;, but not present!&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>

            <span class="n">sigma_slider</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">],</span>
                <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="nb">max</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ipw</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span>
                <span class="n">update</span><span class="p">,</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude_slider</span><span class="p">,</span>
                <span class="n">x_center</span><span class="o">=</span><span class="n">x_center_slider</span><span class="p">,</span>
                <span class="n">y_center</span><span class="o">=</span><span class="n">y_center_slider</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_slider</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">apply_func</span><span class="p">(</span><span class="n">apply</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">common_apply_func</span><span class="p">(</span><span class="n">apply</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>
                <span class="n">sigma_slider</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;correction_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Lorentzian_asymmetric&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;amplitude2&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">correction</span><span class="p">:</span>
                    <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;sigma2&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">correction</span><span class="p">:</span>
                    <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span>
                <span class="n">update</span><span class="p">(</span>
                    <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">],</span>
                    <span class="n">x_center</span><span class="p">,</span>
                    <span class="n">y_center</span><span class="p">,</span>
                    <span class="n">gamma</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">],</span>
                    <span class="n">amplitude2</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude2&quot;</span><span class="p">],</span>
                    <span class="n">gamma2</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma2&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Parameter &#39;gamma&#39; required for correction type &#39;Lorentzian_asymmetric&#39;, &quot;</span><span class="p">,</span>
                    <span class="s2">&quot;but not present!&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>

            <span class="n">gamma_slider</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">],</span>
                <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="nb">max</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">amplitude2_slider</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude2&quot;</span><span class="p">],</span>
                <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">gamma2_slider</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma2&quot;</span><span class="p">],</span>
                <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="nb">max</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ipw</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span>
                <span class="n">update</span><span class="p">,</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude_slider</span><span class="p">,</span>
                <span class="n">x_center</span><span class="o">=</span><span class="n">x_center_slider</span><span class="p">,</span>
                <span class="n">y_center</span><span class="o">=</span><span class="n">y_center_slider</span><span class="p">,</span>
                <span class="n">gamma</span><span class="o">=</span><span class="n">gamma_slider</span><span class="p">,</span>
                <span class="n">amplitude2</span><span class="o">=</span><span class="n">amplitude2_slider</span><span class="p">,</span>
                <span class="n">gamma2</span><span class="o">=</span><span class="n">gamma2_slider</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">apply_func</span><span class="p">(</span><span class="n">apply</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">common_apply_func</span><span class="p">(</span><span class="n">apply</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude2&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;gamma2&quot;</span><span class="p">]</span>
                <span class="n">gamma_slider</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">amplitude2_slider</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">gamma2_slider</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="c1"># pylint: disable=duplicate-code</span>
        <span class="n">apply_button</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;apply&quot;</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">apply_button</span><span class="p">)</span>
        <span class="n">apply_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">apply_func</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">apply</span><span class="p">:</span>
            <span class="n">apply_func</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnergyCalibrator.apply_energy_correction">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.apply_energy_correction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_energy_correction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">tof_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">new_tof_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">correction_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">correction</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">suppress_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply correction to the time-of-flight (TOF) axis of single-event data.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame | dask.dataframe.DataFrame): The dataframe where</span>
<span class="sd">                to apply the energy correction to.</span>
<span class="sd">            tof_column (str, optional): Name of the source column to convert.</span>
<span class="sd">                Defaults to config[&quot;dataframe&quot;][&quot;columns&quot;][&quot;tof&quot;].</span>
<span class="sd">            new_tof_column (str, optional): Name of the destination column to convert.</span>
<span class="sd">                Defaults to config[&quot;dataframe&quot;][&quot;columns&quot;][&quot;corrected_tof&quot;].</span>
<span class="sd">            correction_type (str, optional): Type of correction to apply to the TOF</span>
<span class="sd">                axis. Valid values are:</span>

<span class="sd">                - &#39;spherical&#39;</span>
<span class="sd">                - &#39;Lorentzian&#39;</span>
<span class="sd">                - &#39;Gaussian&#39;</span>
<span class="sd">                - &#39;Lorentzian_asymmetric&#39;</span>

<span class="sd">                Defaults to config[&quot;energy&quot;][&quot;correction_type&quot;].</span>
<span class="sd">            amplitude (float, optional): Amplitude of the time-of-flight correction</span>
<span class="sd">                term. Defaults to config[&quot;energy&quot;][&quot;correction&quot;][&quot;correction_type&quot;].</span>
<span class="sd">            correction (dict, optional): Correction dictionary containing parameters</span>
<span class="sd">                for the correction. Defaults to self.correction or</span>
<span class="sd">                config[&quot;energy&quot;][&quot;correction&quot;].</span>
<span class="sd">            suppress_output (bool, optional): Option to suppress output of diagnostic information.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            **kwds: Additional parameters to use for the correction:</span>

<span class="sd">                - **x_column** (str): Name of the x column.</span>
<span class="sd">                - **y_column** (str): Name of the y column.</span>
<span class="sd">                - **d** (float): Field-free drift distance.</span>
<span class="sd">                - **gamma** (float): Linewidth value for correction using a 2D</span>
<span class="sd">                  Lorentz profile.</span>
<span class="sd">                - **sigma** (float): Standard deviation for correction using a 2D</span>
<span class="sd">                  Gaussian profile.</span>
<span class="sd">                - **gamma2** (float): Linewidth value for correction using an</span>
<span class="sd">                  asymmetric 2D Lorentz profile, X-direction.</span>
<span class="sd">                - **amplitude2** (float): Amplitude value for correction using an</span>
<span class="sd">                  asymmetric 2D Lorentz profile, X-direction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[pd.DataFrame | dask.dataframe.DataFrame, dict]: dataframe with added column</span>
<span class="sd">            and Energy correction metadata dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">correction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">correction</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">)</span>

        <span class="n">x_column</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;x_column&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_column</span><span class="p">)</span>
        <span class="n">y_column</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;y_column&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_column</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tof_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tof_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof_column</span>

        <span class="k">if</span> <span class="n">new_tof_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_tof_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_tof_column</span>

        <span class="k">if</span> <span class="n">correction_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">amplitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">correction_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;correction_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction_type</span>

            <span class="k">if</span> <span class="n">amplitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amplitude</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">correction</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">elif</span> <span class="s2">&quot;creation_date&quot;</span> <span class="ow">in</span> <span class="n">correction</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">suppress_output</span><span class="p">:</span>
            <span class="n">datestring</span> <span class="o">=</span> <span class="n">correction</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y, %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using energy correction parameters generated on </span><span class="si">{</span><span class="n">datestring</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;correction_type&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="s2">&quot;amplitude&quot;</span><span class="p">}</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">correction</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Required correction parameters &#39;</span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&#39; missing!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_output</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correction parameters:</span><span class="se">\n</span><span class="si">{</span><span class="n">correction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="n">new_tof_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">tof_column</span><span class="p">]</span> <span class="o">+</span> <span class="n">correction_function</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">x_column</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">y_column</span><span class="p">],</span>
            <span class="o">**</span><span class="n">correction</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather_correction_metadata</span><span class="p">(</span><span class="n">correction</span><span class="o">=</span><span class="n">correction</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="EnergyCalibrator.gather_correction_metadata">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.gather_correction_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gather_correction_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">correction</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect meta data for energy correction</span>

<span class="sd">        Args:</span>
<span class="sd">            correction (dict, optional): Dictionary with energy correction parameters.</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Generated metadata dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">correction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">correction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correction</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;applied&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">correction</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="EnergyCalibrator.align_dld_sectors">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.align_dld_sectors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">align_dld_sectors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">tof_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sector_id_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sector_delays</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aligns the time-of-flight axis of the different sections of a detector.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (dask.dataframe.DataFrame): Dataframe to use.</span>
<span class="sd">            tof_column (str, optional): Name of the column containing the time-of-flight values.</span>
<span class="sd">                Defaults to config[&quot;dataframe&quot;][&quot;columns&quot;][&quot;tof&quot;].</span>
<span class="sd">            sector_id_column (str, optional): Name of the column containing the sector id values.</span>
<span class="sd">                Defaults to config[&quot;dataframe&quot;][&quot;columns&quot;][&quot;sector_id&quot;].</span>
<span class="sd">            sector_delays (np.ndarray, optional): Array containing the sector delays. Defaults to</span>
<span class="sd">                config[&quot;dataframe&quot;][&quot;sector_delays&quot;].</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[dask.dataframe.DataFrame, dict]: Dataframe with the new columns and Metadata</span>
<span class="sd">            dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sector_delays</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sector_delays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector_delays</span>
        <span class="k">if</span> <span class="n">sector_id_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sector_id_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector_id_column</span>

        <span class="k">if</span> <span class="n">sector_delays</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sector_id_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No value for sector_delays or sector_id_column found in config.&quot;</span>
                <span class="s2">&quot;Config file is not properly configured for dld sector correction.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">tof_column</span> <span class="o">=</span> <span class="n">tof_column</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tof_column</span>

        <span class="c1"># align the 8s sectors</span>
        <span class="n">sector_delays_arr</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">sector_delays</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">align_sector</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">tof_column</span><span class="p">]</span> <span class="o">-</span> <span class="n">sector_delays_arr</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">sector_id_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="n">tof_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">align_sector</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">tof_column</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;applied&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;sector_delays&quot;</span><span class="p">:</span> <span class="n">sector_delays</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="EnergyCalibrator.add_offsets">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.EnergyCalibrator.add_offsets">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_offsets</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">offsets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">constant</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">columns</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">preserve_mean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">reductions</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">energy_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">suppress_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply an offset to the energy column by the values of the provided columns.</span>

<span class="sd">        If no parameter is passed to this function, the offset is applied as defined in the</span>
<span class="sd">        config file. If parameters are passed, they are used to generate a new offset dictionary</span>
<span class="sd">        and the offset is applied using the ``dfops.apply_offset_from_columns()`` function.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame | dask.dataframe.DataFrame): Dataframe to use.</span>
<span class="sd">            offsets (Dict, optional): Dictionary of energy offset parameters.</span>
<span class="sd">            constant (float, optional): The constant to shift the energy axis by.</span>
<span class="sd">            columns (str | Sequence[str]): Name of the column(s) to apply the shift from.</span>
<span class="sd">            weights (float | Sequence[float]): weights to apply to the columns.</span>
<span class="sd">                Can also be used to flip the sign (e.g. -1). Defaults to 1.</span>
<span class="sd">            preserve_mean (bool | Sequence[bool]): Whether to subtract the mean of the column</span>
<span class="sd">                before applying the shift. Defaults to False.</span>
<span class="sd">            reductions (str | Sequence[str]): The reduction to apply to the column. Should be an</span>
<span class="sd">                available method of dask.dataframe.Series. For example &quot;mean&quot;. In this case the</span>
<span class="sd">                function is applied to the column to generate a single value for the whole dataset.</span>
<span class="sd">                If None, the shift is applied per-dataframe-row. Defaults to None. Currently only</span>
<span class="sd">                &quot;mean&quot; is supported.</span>
<span class="sd">            energy_column (str, optional): Name of the column containing the energy values.</span>
<span class="sd">            suppress_output (bool, optional): Option to suppress output of diagnostic information.</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[pd.DataFrame | dask.dataframe.DataFrame, dict]: Dataframe with the new columns</span>
<span class="sd">            and Metadata dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">offsets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">energy_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">energy_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_column</span>

        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;applied&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># flip sign for binding energy scale</span>
        <span class="n">energy_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;energy_scale&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">energy_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Energy scale not set. Cannot interpret the sign of the offset.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">energy_scale</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;binding&quot;</span><span class="p">,</span> <span class="s2">&quot;kinetic&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid energy scale: </span><span class="si">{</span><span class="n">energy_scale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">scale_sign</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">energy_scale</span> <span class="o">==</span> <span class="s2">&quot;binding&quot;</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">constant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># pylint:disable=duplicate-code</span>
            <span class="c1"># use passed parameters, overwrite config</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">offsets</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="c1"># column-based offsets</span>
            <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">offsets</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)):</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">weights</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid type for weights: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid type for weights: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">preserve_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">preserve_mean</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">preserve_mean</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
                    <span class="n">preserve_mean</span> <span class="o">=</span> <span class="p">[</span><span class="n">preserve_mean</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">preserve_mean</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">preserve_mean</span> <span class="o">=</span> <span class="p">[</span><span class="n">preserve_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reductions</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
                    <span class="n">reductions</span> <span class="o">=</span> <span class="p">[</span><span class="n">reductions</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reductions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">reductions</span> <span class="o">=</span> <span class="p">[</span><span class="n">reductions</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

                <span class="c1"># store in offsets dictionary</span>
                <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">pmean</span><span class="p">,</span> <span class="n">red</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">preserve_mean</span><span class="p">,</span> <span class="n">reductions</span><span class="p">):</span>
                    <span class="n">offsets</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
                        <span class="s2">&quot;preserve_mean&quot;</span><span class="p">:</span> <span class="n">pmean</span><span class="p">,</span>
                        <span class="s2">&quot;reduction&quot;</span><span class="p">:</span> <span class="n">red</span><span class="p">,</span>
                    <span class="p">}</span>

            <span class="c1"># constant offset</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constant</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)):</span>
                <span class="n">offsets</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constant</span>
            <span class="k">elif</span> <span class="n">constant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid type for constant: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">constant</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;creation_date&quot;</span> <span class="ow">in</span> <span class="n">offsets</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">suppress_output</span><span class="p">:</span>
            <span class="n">datestring</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y, %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using energy offset parameters generated on </span><span class="si">{</span><span class="n">datestring</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># unpack dictionary</span>
            <span class="c1"># pylint: disable=duplicate-code</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">preserve_mean</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">reductions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;Energy offset parameters:&quot;</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">offsets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;creation_date&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;constant&quot;</span><span class="p">:</span>
                    <span class="c1"># flip sign if binding energy scale</span>
                    <span class="n">constant</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">scale_sign</span>
                    <span class="n">log_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Constant: </span><span class="si">{</span><span class="n">constant</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;columns&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">column_dict</span> <span class="ow">in</span> <span class="n">offsets</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span>
                        <span class="n">weight</span> <span class="o">=</span> <span class="n">column_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)):</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Invalid type for weight of column </span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="c1"># flip sign if binding energy scale</span>
                        <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">scale_sign</span>
                        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
                        <span class="n">pm</span> <span class="o">=</span> <span class="n">column_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preserve_mean&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="n">preserve_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pm</span><span class="p">)</span>
                        <span class="n">red</span> <span class="o">=</span> <span class="n">column_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reduction&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">red</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]:</span>
                            <span class="n">red</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">reductions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">red</span><span class="p">)</span>
                        <span class="n">log_str</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Column[</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">]: Weight=</span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s2">, Preserve Mean: </span><span class="si">{</span><span class="n">pm</span><span class="si">}</span><span class="s2">, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Reductions: </span><span class="si">{</span><span class="n">red</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_output</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">dfops</span><span class="o">.</span><span class="n">offset_by_other_columns</span><span class="p">(</span>
                    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                    <span class="n">target_column</span><span class="o">=</span><span class="n">energy_column</span><span class="p">,</span>
                    <span class="n">offset_columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                    <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
                    <span class="n">preserve_mean</span><span class="o">=</span><span class="n">preserve_mean</span><span class="p">,</span>
                    <span class="n">reductions</span><span class="o">=</span><span class="n">reductions</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># apply constant</span>
        <span class="k">if</span> <span class="n">constant</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constant</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid type for constant: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">constant</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="n">energy_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">energy_column</span><span class="p">]</span> <span class="o">+</span> <span class="n">constant</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span> <span class="o">=</span> <span class="n">offsets</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;offsets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsets</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">metadata</span></div>
</div>



<div class="viewcode-block" id="extract_bias">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.extract_bias">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_bias</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">bias_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read bias values from hdf5 files</span>

<span class="sd">    Args:</span>
<span class="sd">        files (list[str]): List of filenames</span>
<span class="sd">        bias_key (str): hdf5 path to the bias value</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Array of bias values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bias_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_handle</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bias_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;@&quot;</span><span class="p">:</span>
                <span class="n">bias_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">file_handle</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">bias_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bias_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">file_handle</span><span class="p">[</span><span class="n">bias_key</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bias_list</span><span class="p">)</span></div>



<div class="viewcode-block" id="correction_function">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.correction_function">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">correction_function</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">correction_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">center</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">amplitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the TOF correction based on the given X/Y coordinates and a model.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (float | np.ndarray): x coordinate</span>
<span class="sd">        y (float | np.ndarray): y coordinate</span>
<span class="sd">        correction_type (str): type of correction. One of</span>
<span class="sd">            &quot;spherical&quot;, &quot;Lorentzian&quot;, &quot;Gaussian&quot;, or &quot;Lorentzian_asymmetric&quot;</span>
<span class="sd">        center (tuple[int, int]): center position of the distribution (x,y)</span>
<span class="sd">        amplitude (float): Amplitude of the correction</span>
<span class="sd">        **kwds: Keyword arguments:</span>

<span class="sd">            - **diameter** (float): Field-free drift distance.</span>
<span class="sd">            - **gamma** (float): Linewidth value for correction using a 2D</span>
<span class="sd">              Lorentz profile.</span>
<span class="sd">            - **sigma** (float): Standard deviation for correction using a 2D</span>
<span class="sd">              Gaussian profile.</span>
<span class="sd">            - **gamma2** (float): Linewidth value for correction using an</span>
<span class="sd">              asymmetric 2D Lorentz profile, X-direction.</span>
<span class="sd">            - **amplitude2** (float): Amplitude value for correction using an</span>
<span class="sd">              asymmetric 2D Lorentz profile, X-direction.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float | np.ndarray: calculated correction value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">correction_type</span> <span class="o">==</span> <span class="s2">&quot;spherical&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">diameter</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;diameter&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;diameter&#39; required for correction type &#39;</span><span class="si">{</span><span class="n">correction_type</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="s2">&quot;but not provided!&quot;</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="mi">1</span>
                <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">diameter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="n">amplitude</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">correction_type</span> <span class="o">==</span> <span class="s2">&quot;Lorentzian&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gamma&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;gamma&#39; required for correction type &#39;</span><span class="si">{</span><span class="n">correction_type</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="s2">&quot;but not provided!&quot;</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">100000</span>
            <span class="o">*</span> <span class="n">amplitude</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">gamma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">correction_type</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;sigma&#39; required for correction type &#39;</span><span class="si">{</span><span class="n">correction_type</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="s2">&quot;but not provided!&quot;</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">20000</span>
            <span class="o">*</span> <span class="n">amplitude</span>
            <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                    <span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">correction_type</span> <span class="o">==</span> <span class="s2">&quot;Lorentzian_asymmetric&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gamma&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;gamma&#39; required for correction type &#39;</span><span class="si">{</span><span class="n">correction_type</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="s2">&quot;but not provided!&quot;</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
        <span class="n">gamma2</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gamma2&quot;</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">amplitude2</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;amplitude2&quot;</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">)</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">100000</span>
            <span class="o">*</span> <span class="n">amplitude</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">gamma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">correction</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="mi">100000</span>
            <span class="o">*</span> <span class="n">amplitude2</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">gamma2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">gamma2</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">gamma2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">return</span> <span class="n">correction</span></div>



<div class="viewcode-block" id="normspec">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.normspec">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">normspec</span><span class="p">(</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">smooth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">span</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalize a series of 1D signals.</span>

<span class="sd">    Args:</span>
<span class="sd">        specs (np.ndarray): Collection of 1D signals.</span>
<span class="sd">        smooth (bool, optional): Option to smooth the signals before normalization.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        span (int, optional): Smoothing span parameters of the LOESS method</span>
<span class="sd">            (see ``scipy.signal.savgol_filter()``). Defaults to 7.</span>
<span class="sd">        order (int, optional): Smoothing order parameters of the LOESS method</span>
<span class="sd">            (see ``scipy.signal.savgol_filter()``).. Defaults to 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: The matrix assembled from a list of maximum-normalized signals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nspec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
    <span class="n">specnorm</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspec</span><span class="p">):</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">span</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">nsp</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nsp</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">/</span> <span class="n">spec</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">specnorm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nsp</span><span class="p">)</span>

        <span class="c1"># Align 1D spectrum</span>
        <span class="n">normalized_specs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">specnorm</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">normalized_specs</span></div>



<div class="viewcode-block" id="find_correspondence">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.find_correspondence">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_correspondence</span><span class="p">(</span>
    <span class="n">sig_still</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">sig_mov</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the correspondence between two 1D traces by alignment using a</span>
<span class="sd">    time-warp algorithm.</span>

<span class="sd">    Args:</span>
<span class="sd">        sig_still (np.ndarray): Reference 1D signals.</span>
<span class="sd">        sig_mov (np.ndarray): 1D signal to be aligned.</span>
<span class="sd">        **kwds: keyword arguments for ``fastdtw.fastdtw()``</span>
<span class="sd">            - *dist_metric*: Distance metric to use for time warping. Defaults to None.</span>
<span class="sd">            - *radius*: Radius to use for time warping. Defaults to 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Pixel-wise path correspondences between two input 1D arrays</span>
<span class="sd">        (sig_still, sig_mov).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;dist_metric&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;find_correspondence() got unexpected keyword arguments </span><span class="si">{</span><span class="n">kwds</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">pathcorr</span> <span class="o">=</span> <span class="n">fastdtw</span><span class="p">(</span><span class="n">sig_still</span><span class="p">,</span> <span class="n">sig_mov</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">rad</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pathcorr</span><span class="p">)</span></div>



<div class="viewcode-block" id="range_convert">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.range_convert">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">range_convert</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">xrng</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
    <span class="n">pathcorr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert value range using a pairwise path correspondence (e.g. obtained</span>
<span class="sd">    from time warping algorithm).</span>

<span class="sd">    Args:</span>
<span class="sd">        x (np.ndarray): Values of the x axis (e.g. time-of-flight values).</span>
<span class="sd">        xrng (tuple): Boundary value range on the x axis.</span>
<span class="sd">        pathcorr (np.ndarray): Path correspondence between two 1D arrays in the</span>
<span class="sd">            following form,</span>
<span class="sd">            [(id_1_trace_1, id_1_trace_2), (id_2_trace_1, id_2_trace_2), ...]</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Transformed range according to the path correspondence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pathcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pathcorr</span><span class="p">)</span>
    <span class="n">xrange_trans</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">xval</span> <span class="ow">in</span> <span class="n">xrng</span><span class="p">:</span>  <span class="c1"># Transform each value in the range</span>
        <span class="n">xind</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">xval</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">xind_alt</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">xind</span><span class="p">,</span> <span class="n">pathcorr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">xind_trans</span> <span class="o">=</span> <span class="n">pathcorr</span><span class="p">[</span><span class="n">xind_alt</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">xrange_trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">xind_trans</span><span class="p">])</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">xrange_trans</span><span class="p">)</span></div>



<div class="viewcode-block" id="find_nearest">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.find_nearest">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_nearest</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">narray</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the value closest to a given one in a 1D array.</span>

<span class="sd">    Args:</span>
<span class="sd">        val (float): Value of interest.</span>
<span class="sd">        narray (np.ndarray):  The array to look for the nearest value.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Array index of the value nearest to the given one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">narray</span> <span class="o">-</span> <span class="n">val</span><span class="p">)))</span></div>



<div class="viewcode-block" id="peaksearch">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.peaksearch">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">peaksearch</span><span class="p">(</span>
    <span class="n">traces</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">tof</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">ranges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pkwindow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detect a list of peaks in the corresponding regions of multiple spectra.</span>

<span class="sd">    Args:</span>
<span class="sd">        traces (np.ndarray): Collection of 1D spectra.</span>
<span class="sd">        tof (np.ndarray): Time-of-flight values.</span>
<span class="sd">        ranges (list[tuple], optional): List of ranges for peak detection in the format</span>
<span class="sd">        [(LowerBound1, UpperBound1), (LowerBound2, UpperBound2), ....].</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        pkwindow (int, optional): Window width of a peak (amounts to lookahead in</span>
<span class="sd">            ``peakdetect1d``). Defaults to 3.</span>
<span class="sd">        plot (bool, optional): Specify whether to display a custom plot of the peak</span>
<span class="sd">            search results. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Collection of peak positions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pkmaxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">rng</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ranges</span><span class="p">,</span> <span class="n">traces</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">tof</span> <span class="o">&gt;=</span> <span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tof</span> <span class="o">&lt;=</span> <span class="n">rng</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">tofseg</span><span class="p">,</span> <span class="n">trseg</span> <span class="o">=</span> <span class="n">tof</span><span class="p">[</span><span class="n">cond</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>
        <span class="n">maxs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">peakdetect1d</span><span class="p">(</span><span class="n">trseg</span><span class="p">,</span> <span class="n">tofseg</span><span class="p">,</span> <span class="n">lookahead</span><span class="o">=</span><span class="n">pkwindow</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pkmaxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># No peak found for this range</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No peak detected in range </span><span class="si">{</span><span class="n">rng</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tof</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s2">&quot;--k&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tofseg</span><span class="p">,</span> <span class="n">trseg</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">maxs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">maxs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pkmaxs</span><span class="p">)</span></div>



<span class="c1"># 1D peak detection algorithm adapted from Sixten Bergman</span>
<span class="c1"># https://gist.github.com/sixtenbe/1178136#file-peakdetect-py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_datacheck_peakdetect</span><span class="p">(</span>
    <span class="n">x_axis</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y_axis</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Input format checking for 1D peakdetect algorithm</span>

<span class="sd">    Args:</span>
<span class="sd">        x_axis (np.ndarray): x-axis array</span>
<span class="sd">        y_axis (np.ndarray): y-axis array</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Raised if x and y values don&#39;t have the same length.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[np.ndarray, np.ndarray]: Tuple of checked (x/y) arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">x_axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_axis</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_axis</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_axis</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Input vectors y_axis and x_axis must have same length&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Needs to be a numpy array</span>
    <span class="n">y_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_axis</span><span class="p">)</span>
    <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x_axis</span><span class="p">,</span> <span class="n">y_axis</span>


<div class="viewcode-block" id="peakdetect1d">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.peakdetect1d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">peakdetect1d</span><span class="p">(</span>
    <span class="n">y_axis</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">x_axis</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lookahead</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">delta</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function for detecting local maxima and minima in a signal.</span>
<span class="sd">    Discovers peaks by searching for values which are surrounded by lower</span>
<span class="sd">    or larger values for maxima and minima respectively</span>

<span class="sd">    Converted from/based on a MATLAB script at:</span>
<span class="sd">    http://billauer.co.il/peakdet.html</span>

<span class="sd">    Args:</span>
<span class="sd">        y_axis (np.ndarray): A list containing the signal over which to find peaks.</span>
<span class="sd">        x_axis (np.ndarray, optional): A x-axis whose values correspond to the y_axis</span>
<span class="sd">            list and is used in the return to specify the position of the peaks. If</span>
<span class="sd">            omitted an index of the y_axis is used.</span>
<span class="sd">        lookahead (int, optional): distance to look ahead from a peak candidate to</span>
<span class="sd">            determine if it is the actual peak</span>
<span class="sd">            &#39;(samples / period) / f&#39; where &#39;4 &gt;= f &gt;= 1.25&#39; might be a good value.</span>
<span class="sd">            Defaults to 200.</span>
<span class="sd">        delta (int, optional): this specifies a minimum difference between a peak and</span>
<span class="sd">            the following points, before a peak may be considered a peak. Useful</span>
<span class="sd">            to hinder the function from picking up false peaks towards to end of</span>
<span class="sd">            the signal. To work well delta should be set to delta &gt;= RMSnoise * 5.</span>
<span class="sd">            Defaults to 0.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Raised if lookahead and delta are out of range.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[np.ndarray, np.ndarray]: Tuple of positions of the positive peaks,</span>
<span class="sd">        positions of the negative peaks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_peaks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">min_peaks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dump</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Used to pop the first hit which almost always is false</span>

    <span class="c1"># Check input data</span>
    <span class="n">x_axis</span><span class="p">,</span> <span class="n">y_axis</span> <span class="o">=</span> <span class="n">_datacheck_peakdetect</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">y_axis</span><span class="p">)</span>
    <span class="c1"># Store data length for later use</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_axis</span><span class="p">)</span>

    <span class="c1"># Perform some checks</span>
    <span class="k">if</span> <span class="n">lookahead</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lookahead must be &#39;1&#39; or above in value&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">delta</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;delta must be a positive number&quot;</span><span class="p">)</span>

    <span class="c1"># maxima and minima candidates are temporarily stored in</span>
    <span class="c1"># mx and mn respectively</span>
    <span class="n">_min</span><span class="p">,</span> <span class="n">_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="c1"># Only detect peak if there is &#39;lookahead&#39; amount of points after it</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">x_axis</span><span class="p">[:</span><span class="o">-</span><span class="n">lookahead</span><span class="p">],</span> <span class="n">y_axis</span><span class="p">[:</span><span class="o">-</span><span class="n">lookahead</span><span class="p">]),</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">_max</span><span class="p">:</span>
            <span class="n">_max</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">_max_pos</span> <span class="o">=</span> <span class="n">x</span>

        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">_min</span><span class="p">:</span>
            <span class="n">_min</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">_min_pos</span> <span class="o">=</span> <span class="n">x</span>

        <span class="c1"># Find local maxima</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">_max</span> <span class="o">-</span> <span class="n">delta</span> <span class="ow">and</span> <span class="n">_max</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
            <span class="c1"># Maxima peak candidate found</span>
            <span class="c1"># look ahead in signal to ensure that this is a peak and not jitter</span>
            <span class="k">if</span> <span class="n">y_axis</span><span class="p">[</span><span class="n">index</span> <span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="n">lookahead</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_max</span><span class="p">:</span>
                <span class="n">max_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">_max_pos</span><span class="p">,</span> <span class="n">_max</span><span class="p">])</span>
                <span class="n">dump</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># Set algorithm to only find minima now</span>
                <span class="n">_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

                <span class="k">if</span> <span class="n">index</span> <span class="o">+</span> <span class="n">lookahead</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">:</span>
                    <span class="c1"># The end is within lookahead no more peaks can be found</span>
                    <span class="k">break</span>
                <span class="k">continue</span>
            <span class="c1"># else:</span>
            <span class="c1">#    mx = ahead</span>
            <span class="c1">#    mxpos = x_axis[np.where(y_axis[index:index+lookahead]==mx)]</span>

        <span class="c1"># Find local minima</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">_min</span> <span class="o">+</span> <span class="n">delta</span> <span class="ow">and</span> <span class="n">_min</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
            <span class="c1"># Minima peak candidate found</span>
            <span class="c1"># look ahead in signal to ensure that this is a peak and not jitter</span>
            <span class="k">if</span> <span class="n">y_axis</span><span class="p">[</span><span class="n">index</span> <span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="n">lookahead</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_min</span><span class="p">:</span>
                <span class="n">min_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">_min_pos</span><span class="p">,</span> <span class="n">_min</span><span class="p">])</span>
                <span class="n">dump</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># Set algorithm to only find maxima now</span>
                <span class="n">_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">_max</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

                <span class="k">if</span> <span class="n">index</span> <span class="o">+</span> <span class="n">lookahead</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">:</span>
                    <span class="c1"># The end is within lookahead no more peaks can be found</span>
                    <span class="k">break</span>
            <span class="c1"># else:</span>
            <span class="c1">#    mn = ahead</span>
            <span class="c1">#    mnpos = x_axis[np.where(y_axis[index:index+lookahead]==mn)]</span>

    <span class="c1"># Remove the false hit on the first value of the y_axis</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dump</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">max_peaks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_peaks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">dump</span>

    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># When no peaks have been found</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">max_peaks</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">min_peaks</span><span class="p">))</span></div>



<div class="viewcode-block" id="fit_energy_calibration">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.fit_energy_calibration">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fit_energy_calibration</span><span class="p">(</span>
    <span class="n">pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">vals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">binwidth</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">binning</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ref_energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">energy_scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;kinetic&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Energy calibration by nonlinear least squares fitting of spectral landmarks on</span>
<span class="sd">    a set of (energy dispersion curves (EDCs). This is done here by fitting to the</span>
<span class="sd">    function d/(t-t0)**2.</span>

<span class="sd">    Args:</span>
<span class="sd">        pos (list[float] | np.ndarray): Positions of the spectral landmarks</span>
<span class="sd">            (e.g. peaks) in the EDCs.</span>
<span class="sd">        vals (list[float] | np.ndarray): Bias voltage value associated with</span>
<span class="sd">            each EDC.</span>
<span class="sd">        binwidth (float): Time width of each original TOF bin in ns.</span>
<span class="sd">        binning (int): Binning factor of the TOF values.</span>
<span class="sd">        ref_energy (float): Energy value of the feature in the reference</span>
<span class="sd">            trace (eV).</span>
<span class="sd">        t (list[float] | np.ndarray, optional): Array of TOF values. Required</span>
<span class="sd">            to calculate calibration trace. Defaults to None.</span>
<span class="sd">        energy_scale (str, optional): Direction of increasing energy scale.</span>

<span class="sd">            - **&#39;kinetic&#39;**: increasing energy with decreasing TOF.</span>
<span class="sd">            - **&#39;binding&#39;**: increasing energy with increasing TOF.</span>
<span class="sd">        **kwds: keyword arguments:</span>

<span class="sd">            - **t0** (float): constrains and initial values for the fit parameter t0,</span>
<span class="sd">              corresponding to the time of flight offset. Defaults to 1e-6.</span>
<span class="sd">            - **E0** (float): constrains and initial values for the fit parameter E0,</span>
<span class="sd">              corresponding to the energy offset. Defaults to min(vals).</span>
<span class="sd">            - **d** (float): constrains and initial values for the fit parameter d,</span>
<span class="sd">              corresponding to the drift distance. Defaults to 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary of fitting parameters including the following,</span>

<span class="sd">        - &quot;coeffs&quot;: Fitted function coefficients.</span>
<span class="sd">        - &quot;axis&quot;: Fitted energy axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">residual</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">binwidth</span><span class="p">,</span> <span class="n">binning</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">tof2ev</span><span class="p">(</span>
            <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">],</span>
            <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">],</span>
            <span class="n">binwidth</span><span class="p">,</span>
            <span class="n">binning</span><span class="p">,</span>
            <span class="n">energy_scale</span><span class="p">,</span>
            <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">],</span>
            <span class="n">time</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span>
        <span class="k">return</span> <span class="n">model</span> <span class="o">-</span> <span class="n">data</span>

    <span class="n">d_pars</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">t0_pars</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;t0&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">E0_pars</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;E0&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fit_energy_calibration() got unexpected keyword arguments </span><span class="si">{</span><span class="n">kwds</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">pars</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
    <span class="n">pars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">d_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nb">min</span><span class="o">=</span><span class="n">d_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
        <span class="nb">max</span><span class="o">=</span><span class="n">d_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
        <span class="n">vary</span><span class="o">=</span><span class="n">d_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vary&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">pars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;t0&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">t0_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">),</span>
        <span class="nb">min</span><span class="o">=</span><span class="n">t0_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
        <span class="nb">max</span><span class="o">=</span><span class="n">t0_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">binwidth</span> <span class="o">*</span> <span class="n">binning</span><span class="p">),</span>
        <span class="n">vary</span><span class="o">=</span><span class="n">t0_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vary&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">pars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;E0&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">E0_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">vals</span><span class="p">)),</span>
        <span class="nb">min</span><span class="o">=</span><span class="n">E0_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
        <span class="nb">max</span><span class="o">=</span><span class="n">E0_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
        <span class="n">vary</span><span class="o">=</span><span class="n">E0_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vary&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span>
        <span class="n">residual</span><span class="p">,</span>
        <span class="n">pars</span><span class="p">,</span>
        <span class="n">fcn_args</span><span class="o">=</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">binwidth</span><span class="p">,</span> <span class="n">binning</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">leastsq</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fit_report</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="c1"># Construct the calibrating function</span>
    <span class="n">pfunc</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">tof2ev</span><span class="p">,</span>
        <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">binwidth</span><span class="p">,</span>
        <span class="n">binning</span><span class="p">,</span>
        <span class="n">energy_scale</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Return results according to specification</span>
    <span class="n">ecalibdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;energy_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_scale</span>
    <span class="n">energy_offset</span> <span class="o">=</span> <span class="n">pfunc</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">ref_energy</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">energy_offset</span> <span class="o">-</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;axis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfunc</span><span class="p">(</span><span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ecalibdict</span></div>



<div class="viewcode-block" id="poly_energy_calibration">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.poly_energy_calibration">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">poly_energy_calibration</span><span class="p">(</span>
    <span class="n">pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">vals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">ref_energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">aug</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;lstsq&quot;</span><span class="p">,</span>
    <span class="n">energy_scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;kinetic&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Energy calibration by nonlinear least squares fitting of spectral landmarks on</span>
<span class="sd">    a set of (energy dispersion curves (EDCs). This amounts to solving for the</span>
<span class="sd">    coefficient vector, a, in the system of equations T.a = b. Here T is the</span>
<span class="sd">    differential drift time matrix and b the differential bias vector, and</span>
<span class="sd">    assuming that the energy-drift-time relationship can be written in the form,</span>
<span class="sd">    E = sum_n (a_n * t**n) + E0</span>


<span class="sd">    Args:</span>
<span class="sd">        pos (list[float] | np.ndarray): Positions of the spectral landmarks</span>
<span class="sd">            (e.g. peaks) in the EDCs.</span>
<span class="sd">        vals (list[float] | np.ndarray): Bias voltage value associated with</span>
<span class="sd">            each EDC.</span>
<span class="sd">        ref_energy (float): Energy value of the feature in the reference</span>
<span class="sd">            trace (eV).</span>
<span class="sd">        order (int, optional): Polynomial order of the fitting function. Defaults to 3.</span>
<span class="sd">        t (list[float] | np.ndarray, optional): Array of TOF values. Required</span>
<span class="sd">            to calculate calibration trace. Defaults to None.</span>
<span class="sd">        aug (int, optional): Fitting dimension augmentation</span>
<span class="sd">            (1=no change, 2=double, etc). Defaults to 1.</span>
<span class="sd">        method (str, optional): Method for determining the energy calibration.</span>

<span class="sd">            - **&#39;lstsq&#39;**: Use ``numpy.linalg.lstsq``.</span>
<span class="sd">            - **&#39;lsqr&#39;**: Use ``scipy.sparse.linalg.lsqr``</span>

<span class="sd">            Defaults to &quot;lstsq&quot;.</span>
<span class="sd">        energy_scale (str, optional): Direction of increasing energy scale.</span>

<span class="sd">            - **&#39;kinetic&#39;**: increasing energy with decreasing TOF.</span>
<span class="sd">            - **&#39;binding&#39;**: increasing energy with increasing TOF.</span>

<span class="sd">        **kwds: Keyword arguments passed to ``lstsq`` or ``lsqr``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary of fitting parameters including the following,</span>

<span class="sd">        - &quot;coeffs&quot;: Fitted polynomial coefficients (the a&#39;s).</span>
<span class="sd">        - &quot;offset&quot;: Minimum time-of-flight corresponding to a peak.</span>
<span class="sd">        - &quot;Tmat&quot;: the T matrix (differential time-of-flight) in the equation Ta=b.</span>
<span class="sd">        - &quot;bvec&quot;: the b vector (differential bias) in the fitting Ta=b.</span>
<span class="sd">        - &quot;axis&quot;: Fitted energy axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">nvals</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">size</span>

    <span class="c1"># Top-to-bottom ordering of terms in the T matrix</span>
    <span class="n">termorder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvals</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">termorder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">termorder</span><span class="p">,</span> <span class="n">aug</span><span class="p">)</span>
    <span class="c1"># Left-to-right ordering of polynomials in the T matrix</span>
    <span class="n">polyorder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>

    <span class="c1"># Construct the T (differential drift time) matrix, Tmat = Tmain - Tsec</span>
    <span class="n">t_main</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polyorder</span><span class="p">])</span>
    <span class="c1"># Duplicate to the same order as the polynomials</span>
    <span class="n">t_main</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">t_main</span><span class="p">,</span> <span class="p">(</span><span class="n">aug</span> <span class="o">*</span> <span class="p">(</span><span class="n">nvals</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">t_sec</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">termorder</span><span class="p">:</span>
        <span class="n">t_sec</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">**</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polyorder</span><span class="p">])</span>

    <span class="n">t_mat</span> <span class="o">=</span> <span class="n">t_main</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t_sec</span><span class="p">)</span>

    <span class="c1"># Construct the b vector (differential bias)</span>
    <span class="n">bvec</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">bvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">aug</span><span class="p">)</span>

    <span class="c1"># Solve for the a vector (polynomial coefficients) using least squares</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;lstsq&quot;</span><span class="p">:</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">lstsq</span><span class="p">(</span><span class="n">t_mat</span><span class="p">,</span> <span class="n">bvec</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;lsqr&quot;</span><span class="p">:</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">lsqr</span><span class="p">(</span><span class="n">t_mat</span><span class="p">,</span> <span class="n">bvec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="n">poly_a</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Construct the calibrating function</span>
    <span class="n">pfunc</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tof2evpoly</span><span class="p">,</span> <span class="n">poly_a</span><span class="p">)</span>

    <span class="c1"># Return results according to specification</span>
    <span class="n">ecalibdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;coeffs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poly_a</span>
    <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;Tmat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_mat</span>
    <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;bvec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bvec</span>
    <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;energy_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_scale</span>
    <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">pfunc</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">ref_energy</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;axis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfunc</span><span class="p">(</span><span class="o">-</span><span class="n">ecalibdict</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ecalibdict</span></div>



<div class="viewcode-block" id="tof2ev">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.tof2ev">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tof2ev</span><span class="p">(</span>
    <span class="n">tof_distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">time_offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">binwidth</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">binning</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">energy_scale</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">energy_offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;(d/(t-t0))**2 expression of the time-of-flight to electron volt</span>
<span class="sd">    conversion formula.</span>

<span class="sd">    Args:</span>
<span class="sd">        tof_distance (float): Drift distance in meter.</span>
<span class="sd">        time_offset (float): time offset in ns.</span>
<span class="sd">        binwidth (float): Time width of each original TOF bin in ns.</span>
<span class="sd">        binning (int): Binning factor of the TOF values.</span>
<span class="sd">        energy_scale (str, optional): Direction of increasing energy scale.</span>

<span class="sd">            - **&#39;kinetic&#39;**: increasing energy with decreasing TOF.</span>
<span class="sd">            - **&#39;binding&#39;**: increasing energy with increasing TOF.</span>

<span class="sd">        energy_offset (float): Energy offset in eV.</span>
<span class="sd">        t (float): TOF value in bin number.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Converted energy in eV</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">energy_scale</span> <span class="o">==</span> <span class="s2">&quot;kinetic&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1">#         m_e/2 [eV]                      bin width [s]</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">2.84281e-12</span> <span class="o">*</span> <span class="n">sign</span> <span class="o">*</span> <span class="p">(</span><span class="n">tof_distance</span> <span class="o">/</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">binwidth</span> <span class="o">*</span> <span class="n">binning</span> <span class="o">-</span> <span class="n">time_offset</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="o">+</span> <span class="n">energy_offset</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">energy</span></div>



<div class="viewcode-block" id="tof2evpoly">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.tof2evpoly">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tof2evpoly</span><span class="p">(</span>
    <span class="n">poly_a</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">energy_offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Polynomial approximation of the time-of-flight to electron volt</span>
<span class="sd">    conversion formula.</span>

<span class="sd">    Args:</span>
<span class="sd">        poly_a (list[float] | np.ndarray): Polynomial coefficients.</span>
<span class="sd">        energy_offset (float): Energy offset in eV.</span>
<span class="sd">        t (float): TOF value in bin number.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Converted energy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">odr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly_a</span><span class="p">)</span>  <span class="c1"># Polynomial order</span>
    <span class="n">poly_a</span> <span class="o">=</span> <span class="n">poly_a</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">odr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">energy</span> <span class="o">+=</span> <span class="n">poly_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">t</span><span class="o">**</span><span class="n">order</span>
    <span class="n">energy</span> <span class="o">+=</span> <span class="n">energy_offset</span>

    <span class="k">return</span> <span class="n">energy</span></div>



<div class="viewcode-block" id="tof2ns">
<a class="viewcode-back" href="../../../sed/calibrator.html#sed.calibrator.energy.tof2ns">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tof2ns</span><span class="p">(</span>
    <span class="n">binwidth</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">binning</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts the time-of-flight steps to time-of-flight in nanoseconds.</span>

<span class="sd">    designed for use with dask.dataframe.DataFrame.map_partitions.</span>

<span class="sd">    Args:</span>
<span class="sd">        binwidth (float): Time step size in seconds.</span>
<span class="sd">        binning (int): Binning of the time-of-flight steps.</span>
<span class="sd">        t (float): TOF value in bin number.</span>
<span class="sd">    Returns:</span>
<span class="sd">        float: Converted time in nanoseconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">*</span> <span class="n">binwidth</span> <span class="o">*</span> <span class="n">binning</span>
    <span class="k">return</span> <span class="n">val</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, OpenCOMPES team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>